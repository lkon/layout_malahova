var malahova=(function(){var loadingScriptOut={init:function(src,callback,appendTo){var script=document.createElement("script");if(script.readyState&&!script.onload){script.onreadystatechange=function(){if((script.readyState==="loaded"||script.readyState==="complete")&&!script.onloadDone){script.onloadDone=true;callback()}}}else{script.onload=function(){if(!script.onloadDone){script.onloadDone=true;callback()}}}script.type="text/javascript";script.src=src;if(!appendTo){appendTo=document.documentElement.children[0]}appendTo.appendChild(script)},jQ:"https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"};var evt=(function(){if(document.addEventListener){return{add:function(el,type,fn){el.addEventListener(type,fn,false)},remove:function(el,type,fn){el.removeEventListener(type,fn,false)}}}else{if(document.attachEvent){return{add:function(el,type,fn){el.attachEvent("on"+type,fn)},remove:function(el,type,fn){el.detachEvent("on"+type,fn)}}}}}());var PopUp=function(wdw,open,close,callback){var that=this,start,fine;if(typeof wdw==="object"){this.id=wdw.id;this.popUp=wdw}else{if(typeof wdw==="string"){this.id=wdw.replace(/(?:\W*)([\w-_]+)/,"$1");this.popUp=document.querySelector(wdw)}}if(typeof open==="object"){start=open}else{if(typeof open==="string"){start=document.querySelector(open)}}if(typeof close==="object"){fine=close}else{if(typeof close==="string"){fine=this.popUp.querySelector(close)}}evt.add(start,"click",function(){that.show.call(that,callback)});evt.add(fine,"click",function(){that.hide.call(that,callback)})};PopUp.data={};PopUp.prototype.show=function(callback){this.popUp.style.display="";PopUp.data[this.id]=true;if(callback){callback()}return this.id};PopUp.prototype.hide=function(callback){this.popUp.style.display="none";PopUp.data[this.id]=false;if(callback){callback()}return this.id};var auth=(function(){var authOpen=document.querySelector("#auth-open"),authClose=document.querySelector("#auth-close"),enter=new PopUp("#auth",authOpen,authClose);enter.hide();return enter}());var tags=(function(){var list,getData=function(item){var children=item.childNodes,data={value:"",label:"",reset:{},parentReset:{}};if(item.dataset){for(var k in item.dataset){if(k==="value"){data.value=item.dataset[k].replace(/^(\s)*/,"").replace(/(\s)*$/,"")}}}else{var atts=item.attributes;for(var i=0;i<atts.length;i++){if(atts[i].name.indexOf("data-value")===0){data.value=atts[i].nodeValue.replace(/^(\s)*/,"").replace(/(\s)*$/,"")}}}for(var i=0;i<children.length;i++){if(children[i].nodeType===3){data.label=children[i].nodeValue.replace(/^(\s)*/,"").replace(/(\s)*$/,"")}else{if(children[i].nodeType===1&&children[i].nodeName.toLowerCase()==="span"){if(window.getComputedStyle&&getComputedStyle(children[i],null)["display"]=="none"||document.documentElement.currentStyle&&children[i].currentStyle.display=="none"){children[i].style.display="inline"}data.reset=children[i].cloneNode(true);data.parentReset=children[i]}}}return data},getItem=function(event,callback){var e=event||window.event,cnt=e.target||e.srcElement,newClass="_state_checked";if(cnt.nodeName.toLowerCase()!=="li"){return}else{if(/ed$/.test(cnt.className)){return}else{var data=callback(cnt);cnt.className+=newClass;return data}}},createListReqTags=function(Constr,itemData,listReqTags,callback){var itemReqTag=new Constr(itemData,callback);listReqTags.appendChild(itemReqTag)},CreateItemReqTag=function(data,callback){this.item=document.createElement("li");this.item.className="b-tags__item_state_checked";this.label=document.createElement("label");this.label.htmlFor=data.value;this.txt=document.createTextNode(data.label);this.label.appendChild(this.txt);this.box=document.createElement("input");this.box.type="checkbox";this.box.name="tag";this.box.value=data.value;this.box.id=data.value;this.box.style.position="absolute";this.box.style.visibility="hidden";this.box.checked=true;this.closing=data.reset;this.item.appendChild(this.label);this.item.appendChild(this.box);this.item.appendChild(this.closing);this.parentReset=data.parentReset;var self=this;evt.add(this.parentReset,"click",function(){self.reset(callback)});evt.add(this.closing,"click",function(event){var e=event||window.event,cnt=e.target||e.srcElement;if(cnt.nodeName.toLowerCase()==="span"){self.reset(callback)}});return this.item};CreateItemReqTag.prototype.reset=function(callback){if(this.box.checked===true){this.box.checked=false}this.item.parentNode.removeChild(this.item);this.parentReset.parentNode.className=this.parentReset.parentNode.className.replace(/(.+)(?:_s(.+)$)/,"$1");this.parentReset.style.display="none";evt.remove(this.parentReset,"click",function(){this.reset()});if(callback){callback()}};var chooseTag=function(e,form,callback){var data=getItem(e,getData);if(data){if(typeof list==="undefined"){list=document.createElement("ul");list.className="b-tags__list b-search__list";list.style.marginTop="2px";list.style.marginLeft="40px";createListReqTags(CreateItemReqTag,data,list,callback);form.appendChild(list)}else{createListReqTags(CreateItemReqTag,data,list,callback)}}},init=(function(){var form=document.search,input=form.elements.search_string,submit=document.querySelectorAll(".b-form_state_toggle__submit")[0],openTagsWdw=document.querySelector("#tags-open"),txt=openTagsWdw.children[0].innerHTML,tagsWdw=document.querySelector("#tags"),tagsList=tagsWdw.querySelector(".b-tags__list"),closeTagsWdw=tagsWdw.querySelector("#tags-close"),setView=function(){if(PopUp.data[popUpId]&&PopUp.data[popUpId]===true){openTagsWdw.children[0].innerHTML="теги:";submit.style.display="inline-block";input.style.width="600px";if(typeof list==="object"){list.style.marginTop="2px";list.style.marginLeft="40px"}}else{if(PopUp.data[popUpId]===false&&(typeof list==="undefined"||list.hasChildNodes()===false)){openTagsWdw.children[0].innerHTML=txt;submit.style.display="";input.style.width="";if(typeof list==="object"){list.style.margin="0px"}}}},tagsPopUp=new PopUp(tagsWdw,openTagsWdw,closeTagsWdw,setView),popUpId=tagsPopUp.hide();return function(){evt.add(tagsList,"click",function(e){chooseTag(e,form,setView)})}}());return{start:init}}());var slideshow=(function(){var date=(function(){var getCntDate=function(day){return day.getFullYear()+"-"+(day.getMonth().toString().length===1?"0"+(day.getMonth()+1):(day.getMonth()+1))+"-"+(day.getDate().toString().length===1?"0"+day.getDate():day.getDate())},cntDay=new Date(),toDay=getCntDate(cntDay);cntDay.setDate(cntDay.getDate()-1);var oneDayAgo=getCntDate(cntDay);cntDay.setDate(cntDay.getDate()-1);var twoDayAgo=getCntDate(cntDay);return{toDayQuery:"2012-09-07",oneDayAgoQuery:"2012-09-06",twoDayAgoQuery:"2012-09-05"}}()),gallery=document.querySelector(".b-recipe__content-list"),dateList=document.querySelector(".b-recipe__date-list"),CreateRecipe=function(title,page,txt,img){var makeEl=function(el,_class){var htmlEl=document.createElement(el);if(_class){htmlEl.className=_class}return htmlEl},head=makeEl("h2"),link=makeEl("a","b-recipe__caption-head"),text=makeEl("p","b-recipe__caption-text"),image=makeEl("img"),caption=makeEl("figcaption","b-recipe__caption"),figure=makeEl("figure","b-recipe__image"),item=makeEl("li","b-recipe__content-item");link.innerHTML=title;link.href="#"+page;text.innerHTML=txt;image.src="i/b-recipe/"+img;image.alt=title;image.width=699;image.height=426;head.appendChild(link);caption.appendChild(head);caption.appendChild(text);figure.appendChild(image);figure.appendChild(caption);item.appendChild(figure);return item},letTurn=function(){var btns=document.querySelector(".b-recipe__btns"),prev=btns.children[0],next=prev.nextSibling,dist=0,pos=0,maxDist=0,letTurnHandle=function(event){var e=event||window.event,cnt=e.target||e.srcElement,load=loadingScriptOut;if(window.getComputedStyle){dist=parseInt(getComputedStyle(gallery,null).width,10);pos=parseInt(getComputedStyle(gallery,null).left,10)}else{if(document.documentElement.currentStyle){dist=parseInt(document.querySelector(".b-recipe").currentStyle.width,10);pos=parseInt(gallery.currentStyle.left,10)}}maxDist=(gallery.children.length-1)*dist;if(pos%dist!=0){return}if(document.documentElement.className.indexOf("no-csstransitions")===-1){if(cnt==prev){gallery.style.left=((pos+dist)>0?-maxDist:(pos+dist))+"px"}else{if(cnt==next){gallery.style.left=((-pos<maxDist)?(pos-dist):0)+"px"}}}else{var withSupport$=function(){if($&&typeof $==="function"){if(cnt==prev){$(gallery).animate({left:((pos+dist)>0?-maxDist:(pos+dist))+"px"},2000)}else{if(cnt==next){$(gallery).animate({left:((-pos<maxDist)?(pos-dist):0)+"px"},2000)}}}};if(typeof $==="undefined"){load.init(load.jQ,withSupport$,document.body)}else{if($&&typeof $==="function"){withSupport$()}}}};return{yes:function(){evt.add(btns,"click",letTurnHandle)},no:function(){evt.remove(btns,"click",letTurnHandle)}}},showSlide=function(txt){var temp=JSON.parse(decodeURIComponent(txt).replace(/\+/g," ")),fragment=document.createDocumentFragment();if(Object.prototype.toString.call(temp)==="[object Array]"){var len=temp.length;while(len--){var listItem=CreateRecipe(temp[len].head,temp[len].page,temp[len].text,temp[len].img);fragment.appendChild(listItem)}}if(gallery.hasChildNodes()){letTurn().no();var children=gallery.childNodes.length;while(children--){gallery.removeChild(gallery.childNodes[children])}gallery.appendChild(fragment)}else{gallery.appendChild(fragment)}letTurn().yes()},getRecipeFromServer=function(callback,query){var request=new XMLHttpRequest(),urlWithQuery="get_recipe_from_base.php?date="+query;request.onreadystatechange=function(){if(request.readyState==4&&request.status==200){callback(request.responseText)}};request.open("GET",urlWithQuery);request.send(null)},curry=function(fn){var slice=Array.prototype.slice,args=slice.call(arguments,1);return function(){return fn.apply(null,args.concat(slice.apply(arguments)))}},handleOfClick=function(event){var e=event||window.event,cnt=e.target||e.srcElement,defineBranch=function(day){switch(day){case"сегодня":curry(getRecipeFromServer,showSlide)(date.toDayQuery);break;case"вчера":curry(getRecipeFromServer,showSlide)(date.oneDayAgoQuery);break;case"позавчера":curry(getRecipeFromServer,showSlide)(date.twoDayAgoQuery);break;default:break}},value="";for(var i=0;i<dateList.childNodes.length;i++){var child=dateList.childNodes[i];if(child.className.indexOf("state")!==-1){child.className=child.className.replace(/(^\s*.+\s*)(?:\s.+state.+\s*)(\s.)*$/g,"$1$2")}}if(cnt.nodeType===1&&cnt.nodeName.toLowerCase()==="span"){value=cnt.firstChild.nodeValue.toLowerCase();cnt.parentNode.className=cnt.parentNode.className.replace(/(.*\s)*([^^\s*].+)/,"$1$2 $2_state_current")}else{if(cnt.nodeType===1&&cnt.nodeName.toLowerCase()==="li"){value=cnt.firstChild.firstChild.nodeValue.toLowerCase();cnt.className=cnt.className.replace(/(.*\s)*([^^\s*].+)/,"$1$2 $2_state_current")}}defineBranch(value)},setHandleOnList=function(){evt.add(dateList,"click",function(event){handleOfClick(event)})};return{present:function(){curry(getRecipeFromServer,showSlide)(date.toDayQuery)},refresh:setHandleOnList}}());var cookAdvices=(function(){var drawCanvas=(function(){return{init:function(){var canvas=document.querySelector(".b-advice__bg"),img=new Image();canvas._height=(parseInt(getComputedStyle(canvas.parentNode,null).height,10)+40);img.src="i/b-advice/b-advice__bg.jpg";return{ctx:canvas.getContext("2d"),a:15,b:7.5,A:canvas.width,B:canvas._height,img:img}},draw:function(cvs){var ctx=cvs.ctx,a=cvs.a,b=cvs.b,A=cvs.A,B=cvs.B,img=cvs.img;ctx.save();ctx.beginPath();ctx.moveTo(A,(B-a));ctx.bezierCurveTo((A-b),(B-a),(A-a),(B-b),(A-a),B);ctx.lineTo(a,B);ctx.bezierCurveTo(a,(B-b),a,(B-a),0,(B-a));ctx.lineTo(0,a);ctx.bezierCurveTo(b,a,a,b,a,0);ctx.lineTo((A-a),0);ctx.bezierCurveTo((A-a),b,(A-b),a,A,a);ctx.lineTo(A,(B-a));ctx.closePath();var ptn=ctx.createPattern(img,"repeat");ctx.fillStyle=ptn;ctx.fill();var c=a*2/3,d=b*2/3,C=(A-c),D=(B-c);ctx.beginPath();ctx.moveTo(C,(D-c));ctx.bezierCurveTo((C-d),(D-c),(C-c),(D-d),(C-c),D);ctx.lineTo((c+c),D);ctx.bezierCurveTo((c+c),(D-d),(c+d),(D-c),c,(D-c));ctx.lineTo(c,(c+c));ctx.bezierCurveTo((c+d),(c+c),(c+c),(c+d),(c+c),c);ctx.lineTo((C-c),c);ctx.bezierCurveTo((C-c),(c+d),(C-d),(c+c),C,(c+c));ctx.lineTo(C,(D-c));ctx.closePath();ctx.strokeStyle="rgb(255, 255, 255)";ctx.lineJoin="miter";ctx.miterLimit=5;ctx.stroke();ctx.restore()},reDraw:function(cvs,h){cvs.ctx.clearRect(0,0,cvs.A,cvs.B);cvs.B=h;this.draw(cvs)}}}()),getAdviceXHR=(function(){var getResponse=function(request){switch(request.getResponseHeader("Content-Type")){case"text/xml":return request.responseXML;case"text/json":case"application/json":case"text/javascript":case"application/javascript":case"application/x-javascript":return eval(request.responseText);default:return request.responseText}},getAmountAdvs=function(url,callback){var request=new XMLHttpRequest();request.onreadystatechange=function(){if(request.readyState==4&&request.status==200){callback(request.getResponseHeader("Count-content"))}};request.open("HEAD",url);request.send(null)},getAdv=function(url,callback){var request=new XMLHttpRequest();request.onreadystatechange=function(){if(request.readyState==4&&request.status==200){callback(getResponse(request))}};request.open("GET",url);request.send(null)},num=(function(){var max,count=Math.round(Math.random()*10);getAmountAdvs("get_advice_txt.php",function(n){max=parseInt(n,10)});return function(){if(count<(max-1)){count+=1}else{count=0}return count}}()),cvs={},show=function(response){var txt=document.querySelector(".b-advice__text");txt.innerHTML=response;if(/no-canvas/.test(document.documentElement.className)){return}var txtHeight=parseInt(getComputedStyle(txt,null).height,10)+40;drawCanvas.reDraw.call(drawCanvas,cvs,txtHeight)};return{start:function(){var start=document.querySelector(".b-advice__link");evt.add(start,"click",function(){var url="get_advice_txt.php?num="+num();getAdv(url,show)});if(/no-canvas/.test(document.documentElement.className)){return}cvs=drawCanvas.init();cvs.img.onload=function(){return drawCanvas.draw(cvs)}}}}());return{init:getAdviceXHR.start}}());return{init:function(){tags.start();slideshow.present();slideshow.refresh();cookAdvices.init.call(cookAdvices)}}}());window.onload=function(){malahova.init()};